---
title: "review_rmd"
output: html_document
date: "2024-01-04"
---
---
title: "review"
output: 
  rmarkdown::md_document:
    pandoc_args: [
      "--wrap=none"
    ]
---

```{r}
library(rgee)
library(rgeeExtra)
library(tidyverse)
ee_Initialize()
extra_Initialize()
```

Thanks for the fantastic package and the chance to review! I look forward to incorporating it into my work 

I tried to limit the scope of my review to just `{rgeeExtra}` and attempted to avoid functionality of `{rgee}` and also not dig into `EE_extra`/`EE-Mont` python packages on which it wraps. Nonetheless, some of the EE_extra functionality has probably crept into my review as that is what controls the main code that controls `{rgeeExtra}`.


## Package Review

*Please check off boxes as applicable, and elaborate in comments below.  Your review is not limited to these topics, as described in the reviewer guide*

- **Briefly describe any working relationship you have (had) with the package authors.**
- [x] As the reviewer I confirm that there are no [conflicts of interest](https://devguide.ropensci.org/policies.html#coi) for me to review this work (if you are unsure whether you are in conflict, please speak to your editor _before_ starting your review).

## Documentation

The package includes all the following forms of documentation:

- [x] **A statement of need:** clearly stating problems the software is designed to solve and its target audience in README
- [x] **Installation instructions:** for the development version of package and any non-standard dependencies in README
- [ ] **Vignette(s):** demonstrating major functionality that runs successfully locally
  + see below issue/bugs found in vignettes that causes them not to run properly
- [ ] **Function Documentation:** for all exported functions
  + see `Documentation - Functions` section
- [ ] **Examples:** (that run successfully locally) for all exported functions
  + see `Documentation - Examples` section
- [x] **Community guidelines:** including contribution guidelines in the README or CONTRIBUTING, and DESCRIPTION with `URL`, `BugReports` and `Maintainer` (which may be autogenerated via `Authors@R`).

### Documentation - Installation instructions
 
- When I am using a more typical python workflow, I feel like I have a clear view of the venv and anything im adding to it. In this setup, it seems less visible. I believe that is largely intended and makes sense for alot of R userse. Nonetheless it would be nice if there was more documentation on this for people who are more comfortable with python. For example, I would personally find it useful to see an example of how to `pip install` all the necessary dependencies for both `{rgee}` and `{rgeeExtra}` into a pre-existing/or new `venv`.

### Documentation - Examples 
- No documentation on exported mean method https://github.com/r-earthengine/rgeeExtra/blob/7ea67d064e56e9429971d64440d8424df68f6249/R/ops-math.R#L258-L264
- example provided for `Summary.ee.image.Image` returns an image with 0 pixels so I am not reall ysure what exactly it is supposed to be doing?
- Example on exported `names.ee.feature.Feature` method doesnt show function being used: https://github.com/r-earthengine/rgeeExtra/blob/7ea67d064e56e9429971d64440d8424df68f6249/R/ops-subsetting-fc.R#L57-L69
- Missing roxygen examples for `[` `[[` examples in `ops-subsetting-image.R`. It's not entirely clear what these are meant to do on an image so I think examples help
- ops-subsetting-imagecollection the 2 top funcs have the same roxygen description but doing differnt things
- `ops-subsetting.R` top example should have a `library(rgeeExtra)` call right?

### Documentation - Functions

- `ee$Image$Extra_preprocess()` - use, examples, and documentation a bit opaque.unclear what the `...` arguments should be as it references `ee$Image$cloudmask()` which I do not believe is a function (maybe you meant `Extra_maskClouds`?). Since there are different ways to cloud mask different images perhaps the documentation can give some information about the defaults and which satellites they are optimal for.
- vignettes:
  + `ee_utils_gif_save()` roxygen says `@return No return value, called to write a GIF file.` but it does return a logical after writing the gif (i'm not sure why this is necessary)
  + how are fonts controlled?
  + In examples and vignettes you

## Functionality

- [x] **Installation:** Installation succeeds as documented.
- [ ] **Functionality:** Any functional claims of the software have been confirmed.
  + some arguments do not behave exactly as stated in documentation (Extra_closest)
- [x] **Performance:** Any performance claims of the software have been confirmed.
- [x] **Automated tests:** Unit tests cover essential functions of the package and a reasonable range of inputs and conditions. All tests pass on the local machine.
- [ ] **Packaging guidelines**: The package conforms to the rOpenSci packaging guidelines.

Estimated hours spent reviewing:8 so far

- [x] Should the author(s) deem it appropriate, I agree to be acknowledged as a package reviewer ("rev" role) in the package DESCRIPTION file.



## Functionality

### Functinoality -Installation

- Worked fine for me. However in the past I have seen alot users struggle (including myself), but I think it has gotten easier.

### Functionality - Functionality


**Exra_Closest**
This is a very handy function! I have found a couple issues and one enhancement idea
**issues**
1. freezing
2. can't take r dates (ck ee$Dates)
3. what if images are equal dist
**enhancement ideas:**
1. I think user should be able to also supply an image instead of a date. The function then should find the closest image in the image collection to that date Like they in the `find_closest()` function in this [example](https://developers.google.com/earth-engine/tutorials/community/histogram-matching). I think it is pretty simple to implement -- something even like what i've written below
2. merge_bands mult!

`?ee_ImageCollection_closest` states: "dateee$Date or R date object. Date of interest for searching the closest image." But doesn't seem to work with R date. Also is that a typo in the documentation **dateee$Date**?

```{r}
date_chr <- "2023-09-10"
date_dt<- as_date(date_chr)

ic_closest_from_dt_obj <-  ic$Extra_closest(date_dt)
#> Error in py_call_impl(callable, call_args$unnamed, call_args$named) : 
#>   ee.ee_exception.EEException: Invalid argument specified for ee.Date(): 2023-09-10
#> Run `reticulate::py_last_error()` for details.
```



### Review Comments
## General Comments

- unclear how this fits into ee-mont?
- guard rails/ defensive checks put in ops-subsetting are nice -- can these be given to others?

- There are several functions that will completely freeze Rsession 


## Code style
- recommendation is use `<-` over `->` Put examples

- in vignettes and examples you seem to embrace the `%>%` syntax for chaining together `{rgee}`/`{rgeeExtra}` processes like this:

```{r}
doi <- ee$ImageCollection("NASA/GPM_L3/IMERG_V06")[[1]] %>%
  ee$Image$Extra_getDOI()
```

rather than:
```{r}
doi <- ee$ImageCollection("NASA/GPM_L3/IMERG_V06")[[1]]$
  Extra_getDOI()
```

is this somehow best practices or you just think easier for R-users? I think the second is certainly easier for users w/ experience in GEE code editor. I also think it's cleaner especially when chaining together many processes.I guess the issue is that it currenlty when using the `$` on ee object you don't get the `rgeeExtra` functions directly. I think this would be a huge improvement if possible.

I'd make it clear somewhere in the documentation that you can do both and when or why you might choose one style over the other.

- can remove leftover code
https://github.com/r-earthengine/rgeeExtra/blob/7ea67d064e56e9429971d64440d8424df68f6249/R/ops-math.R#L108-L110
-w/ summary methods you rename the new band to "layer" no matter what operation( `summ_r$rename("layer")`)? Would it be safer to explicitly rename the band based on the band_name + Reducer name (i.e B1_max)?
-`raster.R` - why is this file called raster? name seems out of place?

**ee_get()**
- wonder if this name is a bit ambiguous considering all the `get_*` functions there are in `rgee`,`GEE` and `rgeeExtra`... a couple ideas:
- somethings with filter (filterIndex, filter_index)?
- just ic_idx?
- something with Subset ... subset_index?



## Names
```{r}

```










## Histogram matching & Closest.
- Would be useful to add `Map$addLayer()|Map$addLayer()` to roxygen example on function
- unclear why this doesnt work is it a bug or user error? If user error, what would be some good ways to trouble shoot?
```{r}

geometry = ee$Geometry$Polygon(
  list(
    c(-155.97117211519446, 20.09006980142336),
    c(-155.97117211519446, 19.7821681268256),
    c(-155.73256280122962, 19.7821681268256),
    c(-155.73256280122962, 20.09006980142336)
  )
)
skysat = ee$Image('SKYSAT/GEN-A/PUBLIC/ORTHO/RGB/s01_20161020T214047Z')$clip(geometry)
landsat_ic = ee$ImageCollection('LANDSAT/LC08/C01/T1_SR')$
  filterBounds(geometry) %>% 
  ee$ImageCollection$Extra_preprocess()

date_skysat <- ee_get_date_img(skysat)$time_start # if you run Extra_closest w/ this it aborts session
date_skysat_chr<- as.character(as_date(date_skysat))

landsat_ic_closest <- ee$ImageCollection$Extra_closest(landsat_ic ,date_skysat_chr,32,"day")

# would be nice if Extra_closest returns img in the above
landsat_img_closest <- landsat_ic_closest[[1]]
# names(landsat_img_closest)[c("B1","B2","B3")]
# names(landsat_img_closest[[c("B4","B3","B2")]]) <- c("R","G","B")
# names(skysat)


landsat_img_rgb <- landsat_img_closest$select(
  opt_selectors = c( "B4","B3","B2"),
  opt_names = c("R","G","B")
)

bands <- list("R"="R","G"="G","B"="B")
matched <- ee$Image$Extra_matchHistogram(skysat,landsat_img_rgb,  bands)
rgeeExtra::ee_minValue(matched)
rgeeExtra::ee_maxValue(matched)
#' source <- ee$Image("LANDSAT/LC08/C01/T1_TOA/LC08_047027_20160819")
#' target <-ee$Image("LANDSAT/LE07/C01/T1_TOA/LE07_046027_20150701")
#' bands <- list("B4"="B3", "B3"="B2", "B2"="B1")
#'
#' matched <- ee$Image$Extra_matchHistogram(source, target, bands)


vis_params_refl = list('min'=0, 'max'= 0.25)
vis_params_dn = list('min'= 0, 'max'= 255)
aoi_center_pt <- ee$Geometry$Point(c(-155.79584,19.9986))
Map$centerObject(aoi_center_pt,13)

m1 <- Map$addLayer(landsat_img_rgb, visParams = vis_params_refl,"landsat ref")
m2 <- Map$addLayer(skysat,visParams= vis_params_dn, 'SkySat source')
m1|m2
m3 <- Map$addLayer(matched,visParams= vis_params_refl, 'SkySat matched')


landsat_img_sel <- landsat_img_closest$select(
  opt_selectors = c( "B4","B3","B2")
)
names(landsat_img_sel)
bands <- list("R"="B4","G"="B3","B"="B2")
matched <- ee$Image$Extra_matchHistogram(skysat,landsat_img_sel,  bands)
names(matched)
names(skysat)
names(landsat_img_sel)

rgeeExtra::ee_minValue(matched)
rgeeExtra::ee_maxValue(matched)
m1 <- Map$addLayer(landsat_img_sel, visParams = vis_params_refl,"landsat ref")
m2 <- Map$addLayer(skysat,visParams= vis_params_dn, 'SkySat source')
m3 <- Map$addLayer(matched,visParams= vis_params_refl, 'SkySat matched')
m2|m3



# from - https://r-earthengine.com/rgeeExtra/articles/Image.html#histogram-matching
# Load Landsat 8 and 7 images for histogram matching.
source <- ee$Image("LANDSAT/LC08/C02/T1_TOA/LC08_047027_20160819")
target <- ee$Image("LANDSAT/LE07/C02/T1_TOA/LE07_046027_20150701")

# Map Landsat 8 bands to corresponding Landsat 7 bands.
bands <- list("B4"="B3", "B3"="B2", "B2"="B1")

# Apply histogram matching from source to target using the band mapping.
matched <- ee$Image$Extra_matchHistogram(source, target, bands)

# Visualization settings for the images.
visParams <- list(
  bands = c("B4","B3","B2"),
  min = 0.1, 
  max = 0.5, 
  gamma = 1.5
)

# Display matched and target images on the map for comparison.
Map$setCenter(lon = -121.984, lat = 47.847, zoom = 14)
m1 <- Map$addLayer(matched, visParams = visParams, "matched") 
m2 <- Map$addLayer(target, visParams = visParams, "target")

m1 | m2  
```

- enhancement idea: add a `list_spectral_indices()` type function (like eemont.listIndices())- would be cool if the object returned would provide the formula & reference for the index as well
- mention [ee_extra](https://github.com/r-earthengine/ee_extra) package somewhere in readme?
- a fair amount of functions freeze R session - any checks warnings that could be put in place?


## Ops-Math

roxygen in below snippet says multiplication, but shows addition 
https://github.com/r-earthengine/rgeeExtra/blob/7ea67d064e56e9429971d64440d8424df68f6249/R/ops-math.R#L40-L44







### Functionality
- `raster.R` - can we add  some defensive class checks so that it doesnt try to run on anything other than `image`? Otherwise user has to wait along time fro the cryptic "ee.ee_exception.EEException: User memory limit exceeded" message.

